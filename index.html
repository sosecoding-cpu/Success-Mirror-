<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Success Mirror</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
/* --- MODIFIED CSS FOR MOBILE SCROLLING --- */
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
body{background:linear-gradient(135deg,#3a7bd5,#3a6073);min-height:100vh;
     display:flex;justify-content:center;
     align-items: flex-start; 
     padding-top: 20px; 
     padding-bottom: 20px;}

#splash{position:fixed;inset:0;display:flex;flex-direction:column;
        justify-content:center;align-items:center;
        background:linear-gradient(135deg,#3a7bd5,#3a6073);
        animation:fadeOut 1s ease 3s forwards;z-index:99;}
#splash img{width:120px;animation:pop 1s ease;}
#splash h1{color:#fff;font-size:2.2rem;margin-top:20px;text-shadow:0 4px 10px rgba(0,0,0,.3);}
@keyframes pop{0%{transform:scale(0);opacity:0;}100%{transform:scale(1);opacity:1;}}
@keyframes fadeOut{to{opacity:0;visibility:hidden;pointer-events:none;}}

.panel{
  position:absolute;width:100%;max-width:900px;
  background:rgba(255,255,255,0.08);backdrop-filter:blur(10px);
  border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.25);
  padding:28px;color:#fff;text-align:center;
  opacity:0;transform:translateY(40px);
  transition:all .5s ease;pointer-events:none;
  max-height: 95vh;
  overflow-y: auto;
}

.panel.active{opacity:1;transform:translateY(0);pointer-events:auto; position: relative;}
.panel h2{margin-bottom:16px;font-weight:600;}
button{
  background:#fff;color:#3a6073;border:none;border-radius:8px;
  padding:10px 18px;font-weight:600;font-size:1rem;
  cursor:pointer;transition:.25s;margin:10px 0;
}
button:hover{background:#3a7bd5;color:#fff;}
.links{margin-top:12px;font-size:.9rem;}
.links a{color:#fff;text-decoration:underline;cursor:pointer;}
.input-group{text-align:left;margin-bottom:14px;}
.input-group label{font-size:.9rem;margin-bottom:6px;display:block;}
.input-group input{
  width:100%;padding:12px;border:none;border-radius:8px;
  background:rgba(255,255,255,0.06);color:#fff;font-size:1rem;
}
.input-group input::placeholder{color:#e0e0e0;}
.grid{display:grid;gap:18px;justify-items:center;}
.cards{grid-template-columns:repeat(auto-fit,minmax(140px,1fr));width:100%;}
.subjects{grid-template-columns:repeat(auto-fit,minmax(120px,1fr));width:100%;}
.resources{grid-template-columns:repeat(auto-fit,minmax(150px,1fr));width:100%;}
.chapters{grid-template-columns:repeat(auto-fit,minmax(160px,1fr));width:100%;}
.card,.subject,.resource,.chapter{
  background:rgba(255,255,255,0.12);
  border-radius:12px;padding:18px 12px;color:#fff;
  font-size:1.05rem;font-weight:600;cursor:pointer;
  transition:transform .2s, background .2s;box-shadow:0 6px 18px rgba(0,0,0,0.25);
  width:100%;text-align:center;
}
.card:hover,.subject:hover,.resource:hover,.chapter:hover{
  transform:translateY(-6px);background:rgba(255,255,255,0.18);
}
.card.disabled,.chapter.disabled,.subject.disabled{position:relative;cursor:default;opacity:0.7;}
.card.disabled::after,.chapter.disabled::after,.subject.disabled::after{
  content:"Coming Soon üîí";
  position:absolute;top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,0.55);display:flex;align-items:center;justify-content:center;
  font-size:0.95rem;font-weight:700;border-radius:12px;color:#fff;
}
.resource.disabled{position:relative;cursor:default;opacity:0.7;}
.resource.disabled::after{
  content:"Locked üîí";
  position:absolute;top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,0.55);display:flex;align-items:center;justify-content:center;
  font-size:0.95rem;font-weight:700;border-radius:12px;color:#fff;
}
.backBtn{margin-bottom:12px;}
.small{font-size:0.9rem;color:rgba(255,255,255,0.9);margin-top:8px;}
/* Style for injected resource links */
.resource-link{
  display:block;
  background:rgba(255,255,255,0.12);
  border-radius:8px;
  padding:15px;
  margin:10px 0;
  text-decoration:none;
  color:#fff;
  font-weight:600;
  transition:.2s;
}
.resource-link:hover{
  background:rgba(255,255,255,0.25);
  transform:scale(1.02);
}

/* --- NEW CSS FOR NOTES VIEWER IFRAME --- */
#notesViewerFrame {
    width: 100%;
    height: calc(95vh - 120px); 
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    background-color: #f0f0f0; 
}
</style>
</head>
<body>

<div id="splash">
  <img src="https://i.ibb.co/pjxMsDq6/1758450615971.png" alt="Logo">
  <h1>Success Mirror</h1>
  <div class="small">Tuition study material</div>
</div>

<div id="loginPanel" class="panel">
  <h2>Welcome Back üëã</h2>
  <div class="input-group"><label>Email</label>
    <input type="email" id="loginEmail" placeholder="Enter your email"></div>
  <div class="input-group"><label>Password</label>
    <input type="password" id="loginPass" placeholder="Enter password"></div>
  <button onclick="signIn()">Login</button>
  <div class="links">
    <a onclick="showPanel('signupPanel')">Create account</a> |
    <a onclick="showPanel('forgotPanel')">Forgot password?</a>
  </div>
</div>

<div id="signupPanel" class="panel">
  <h2>Create Account ‚ú®</h2>
  <div class="input-group"><label>Email</label>
    <input type="email" id="signupEmail" placeholder="Enter email"></div>
  <div class="input-group"><label>Password (min 6 chars)</label>
    <input type="password" id="signupPass" placeholder="Enter password"></div>
  <button onclick="signUp()">Sign Up</button>
  <div class="links"><a onclick="showPanel('loginPanel')">Back to login</a></div>
</div>

<div id="forgotPanel" class="panel">
  <h2>Reset Password üîë</h2>
  <div class="input-group"><label>Email</label>
    <input type="email" id="resetEmail" placeholder="Enter your email"></div>
  <button onclick="forgotPass()">Send Reset Link</button>
  <div class="links"><a onclick="showPanel('loginPanel')">Back to login</a></div>
</div>

<div id="homePanel" class="panel">
  <h2>Welcome to Success Mirror üéØ</h2>
  
  <div style="display: flex; justify-content: center; gap: 15px; margin-bottom: 20px;">
    <button onclick="openHomePanel()">Home üè†</button> 
    <button onclick="alert('SM Store coming soon!')">SM Store üõçÔ∏è</button>
    <button onclick="alert('Proceeding to Fee Payment...')">Pay fees üí≥</button>
    <button onclick="logOut()">Log Out</button>
  </div>
  
  <div class="grid cards">
    <div class="card" onclick="openSubjects('Class 9')">Class 9</div>
    <div class="card disabled">Class 10</div>
    <div class="card disabled">Class 11</div>
    <div class="card disabled">Class 12</div>
  </div>
</div>

<div id="subjectsPanel" class="panel">
  <h2 id="subjectsTitle">Subjects üìö</h2>
  <button class="backBtn" onclick="history.back()">‚¨Ö Back</button> 
  <div class="grid subjects">
    <div class="subject" onclick="openResources('Science')">Science</div>
    <div class="subject" onclick="openResources('Math')">Maths</div>
    <div class="subject" onclick="openResources('English')">English</div>
    <div class="subject" onclick="openResources('Social Science')">Social Science</div>
    <div class="subject disabled" title="Coming soon">Hindi</div>
    <div class="subject disabled" title="Coming soon">Sanskrit</div>
    <div class="subject disabled" title="Coming soon">AI / IT / PE</div>
  </div>
</div>

<div id="resourcesPanel" class="panel">
  <h2 id="resourceTitle">Resources</h2>
  <button class="backBtn" onclick="history.back()">‚¨Ö Back</button>
  <div id="resourceGrid" class="grid resources"></div>
</div>

<div id="chapterPanel" class="panel">
  <h2 id="chapterTitle">Chapters</h2>
  <button class="backBtn" onclick="history.back()">‚¨Ö Back</button>
  <div id="chapterGrid" class="grid chapters"></div>
</div>

<div id="detailPanel" class="panel">
  <h2 id="detailTitle">Chapter Details</h2>
  <button class="backBtn" onclick="history.back()">‚¨Ö Back</button>
  <div id="detailContent" style="margin-top: 20px;">
    </div>
</div>

<div id="notesViewerPanel" class="panel">
  <h2 id="notesViewerTitle">Viewing Notes üìÑ</h2>
  <button class="backBtn" onclick="history.back()">‚¨Ö Back</button>
  <iframe id="notesViewerFrame" title="Notes Viewer" loading="lazy"></iframe>
</div>

<script type="module">
/* ================= Firebase imports ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  sendPasswordResetEmail,
  signOut,
  // --- SESSION PERSISTENCE IMPORTS ADDED ---
  browserLocalPersistence
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

/* ================= Firebase config (your keys) ================= */
const firebaseConfig = {
  apiKey: "AIzaSyBrAPj473on9DbbbAXzsK7nRTTdyx8HlJ8",
  authDomain: "success-mirror-707ad.firebaseapp.com",
  projectId: "success-mirror-707ad",
  storageBucket: "success-mirror-707ad.firebasestorage.app",
  messagingSenderId: "964747672155",
  appId: "1:964747672155:web:d7bc8e7acf55bfd259dd7e",
  measurementId: "G-Z8N3FH59MY"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

/* ================= Utility: safe element getter ================= */
const $ = id => document.getElementById(id);

/* ================= Panel show/hide ================= */
function showPanel(id, isPopState = false){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  const el = document.getElementById(id);
  if(el) el.classList.add('active');
  
  if (!isPopState) {
      window.history.pushState({ panelId: id }, '', '#' + id);
  }
}
window.showPanel = showPanel; 

// Listen for the back/forward button press
window.addEventListener('popstate', (event) => {
    if (event.state && event.state.panelId) {
        showPanel(event.state.panelId, true);
    } else if (window.location.hash) {
        showPanel(window.location.hash.substring(1), true);
    } 
});


window.openHomePanel = () => showPanel('homePanel');


/* ================= Splash ‚Üí login timing ================= */
setTimeout(()=>{ 
    window.history.replaceState({ panelId: 'loginPanel' }, '', '#loginPanel');
    showPanel('loginPanel', true); 
}, 4200);

/* ================= App Configuration ================= */
const LOCKED_SUBJECTS = new Set(["Hindi","Sanskrit","AI / IT / PE"]);
const commonResources = ["Notes","Sample Paper","NCERT PDF"];
const LOCKED_RESOURCES = ["Lecture"]; 

/* ================= Chapter Lists for English (for clarity and maintenance) ================= */
const englishProse = ["The Fun They Had","The Sound of Music","The Little Girl","A Truly Beautiful Mind","The Snake and the Mirror","My Childhood","Reach for the Top","Kathmandu","If I Were You"];
const englishPoem = ["The Road Not Taken","Wind","Rain on the Roof","The Lake Isle of Innisfree","A Legend of the Northland","No Men Are Foreign","On Killing a Tree","A Slumber Did My Spirit Seal"];
const englishMoments = ["The Lost Child","The Adventure of Toto","Iswaran the Story Teller","In the Kingdom of Fools","The Happy Prince","Weathering the Storm in Ersama","The Last Leaf","A House Isn't a Home","The Beggar"];
const englishGrammar = ["Tenses","Modals","Subject Verb Agreement","Reported Speech","Determiners"];
const englishWriting = ["Descriptive Paragraph","Story Writing","Diary Entry"];

/* ================= Mid Term sample PDF links ================= */
const midTermLinks = {
  "Hindi": "#", 
  "Math": "https://drive.google.com/file/d/1RXErUPe88EHX9iX96TMRUtY8VgY9Kl30/preview",
  "Social Science": "https://drive.google.com/file/d/1XffZ0NTTQRzdZLgqNfW44O7BCrvp3xfY/preview",
  "Sanskrit": "#", 
  "Science": "https://drive.google.com/file/d/170iyNSKrkI7p2LJAmITMnOw3e96o01yb/preview",
  "English": "https://drive.google.com/file/d/1jIStqigsAEtvZxr4q78gcqd0lGx-a8qc/preview"
};


/* ================= NCERT shortcuts (ALL LINKS) ================= */
const ncertLinks = {
  "Science": "https://drive.google.com/file/d/1MhSS6yVdtlIB3LPoakSRdVBBeoZunJBg/preview",
  "Math": "https://drive.google.com/file/d/1H_XbswI2KhW7It98kQeN4yZVEWYPuj7k/preview",
  "EnglishBeehive": "https://drive.google.com/file/d/1lfT8x70ehiK8sNCsrm8IcRaGgfNmxpw-/preview",
  "Moments": "https://drive.google.com/file/d/1FRrrtHGlINN1tqD9LS0oQeNNrNMyA8_t/preview",
  "History": "https://drive.google.com/file/d/15KcpA1ViKL93fa6f4tTz4c03sAOfq10h/preview", 
  "Geography": "https://drive.google.com/file/d/12h05xPyke6LcrS5aPWNH-lwPRpuPDv3f/preview",
  "Civics": "https://drive.google.com/file/d/1Z-xbcq8umUudMhzHWOh0D6sCT98-qdV5/preview",
  "Economics": "https://drive.google.com/file/d/1PRt0kIFz09K3njXISlo_pynLhtJ-LjMi/preview"
};

/* ================= Full resources data (notes + lecture) ================= */
const resourcesData = {
  "Science": {
    "NCERT": { notes: ncertLinks["Science"] },
    "Matter In our Surrounding": { notes: "https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf", lecture: "no-lecture-link" },
    "Is Matter Around Us Pure": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Atom and Molecule": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Structure of Atom": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "The Fundamental Unit of Life": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Tissue": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Motion": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Force and Law of Motion": { notes: "no-lecture-link", lecture: "no-lecture-link" },
    "Gravitation": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Work, Power and Energy": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Sound": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Improvement In Food Resources": { notes: "no-notes-link", lecture: "no-lecture-link" }
  },
  "Math": {
    "NCERT": { notes: ncertLinks["Math"] },
    "Number System": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Polynomial": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Co-ordinate Geometry": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Linear equations in two variable": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Introduction to Euclid's Geometry": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Lines and angles": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Triangles": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Quadrilaterals": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Circle": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Heron's Formula": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Surface area and volume": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Statistics": { notes: "no-notes-link", lecture: "no-lecture-link" }
  },
  "English": {
    "NCERT_Beehive": { notes: ncertLinks["EnglishBeehive"] },
    "NCERT_Moments": { notes: ncertLinks["Moments"] },
    ...englishProse.reduce((acc, chap) => ({ ...acc, [chap]: { notes: "no-notes-link", lecture: "no-lecture-link" } }), {}),
    ...englishPoem.reduce((acc, chap) => ({ ...acc, [chap]: { notes: "no-notes-link", lecture: "no-lecture-link" } }), {}),
    ...englishMoments.reduce((acc, chap) => ({ ...acc, [chap]: { notes: "no-notes-link", lecture: "no-lecture-link" } }), {}),
    ...englishGrammar.reduce((acc, chap) => ({ ...acc, [chap]: { notes: "no-notes-link", lecture: "no-lecture-link" } }), {}),
    ...englishWriting.reduce((acc, chap) => ({ ...acc, [chap]: { notes: "no-notes-link", lecture: "no-lecture-link" } }), {})
  },
  "Social Science": {
    "NCERT_History": { notes: ncertLinks["History"] },
    "NCERT_Geography": { notes: ncertLinks["Geography"] }, 
    "NCERT_Civics": { notes: ncertLinks["Civics"] },       
    "NCERT_Economics": { notes: ncertLinks["Economics"] }, 
    "The French Revolution": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Socialism In Europe and the Russian revolution": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Nazims and the rise of Hitler": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Forest society and Colonialism": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Pastoralists in the morden world": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "India size and location": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Physical feature of India": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Drainage": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Climate": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Natural vegetation and wildlife": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Population": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "What is democracy ? Why is democracy ?": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Constitutional Design": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Electoral Politics": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Work of institutions": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Democratic Rights": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "The story of village Palampur": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "People as resource": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Poverty as a challenge": { notes: "no-notes-link", lecture: "no-lecture-link" },
    "Food security in India": { notes: "no-notes-link", lecture: "no-lecture-link" }
  }
};

/* ================= State ================= */
let currentSubject = "";
let resourceType = "";
let currentClass = "";

/* ================= Primary Navigation Functions ================= */

// Handle Class Clicks
window.openSubjects = (className) => {
    currentClass = className;
    if (className !== 'Class 9') {
        alert(className + " is locked / coming soon. üîí");
        return;
    }
    document.getElementById('subjectsTitle').textContent = `${className} Subjects üìö`;
    showPanel('subjectsPanel');
};

// Handle Subject Clicks -> Open Resources Panel
window.openResources = (subject) => {
  if(LOCKED_SUBJECTS.has(subject)){
    alert(subject + " is locked / coming soon.");
    return;
  }
  currentSubject = subject;
  document.getElementById('resourceTitle').textContent = subject + " Resources üìÇ";
  const grid = document.getElementById('resourceGrid');
  grid.innerHTML = "";
  
  [...commonResources, ...LOCKED_RESOURCES].forEach(r=>{
    const div = document.createElement('div');
    div.className = LOCKED_RESOURCES.includes(r) ? 'resource disabled' : 'resource';
    div.textContent = r;
    div.onclick = ()=> handleResourceClick(r);
    grid.appendChild(div);
  });
  showPanel('resourcesPanel');
};

/* ================= Core Logic Functions ================= */

// Handle Resource Clicks -> Determine next step (Chapters, Direct Link, or Alert)
function handleResourceClick(r){
  resourceType = r;

  if(LOCKED_RESOURCES.includes(r)){
    alert(r + " is locked / coming soon! üîí");
    return;
  }

  // 1. NCERT PDF Flow
  if(r === "NCERT PDF"){
    if(currentSubject === "English"){
        showChapters(["Beehive NCERT PDF", "Moments NCERT PDF"]);
    } else if (currentSubject === "Social Science") { 
        showChapters(["History NCERT PDF", "Geography NCERT PDF", "Civics NCERT PDF", "Economics NCERT PDF"]);
    } else {
        const linkKey = currentSubject === "Science" ? "Science" : currentSubject === "Math" ? "Math" : null;
        const link = linkKey ? ncertLinks[linkKey] : null;

        if(link && link !== "#"){
           openNotesViewer(link, `NCERT PDF: ${currentSubject}`);
        } else {
           alert(`NCERT for ${currentSubject} not available.`);
        }
    }
    return;
  }

  // 2. Sample Paper Flow
  if(r === "Sample Paper"){
    showChapters(["Mid Term","Final Term"]);
    return;
  }

  // 3. Notes/Lecture Flow
  if(r === "Notes" || r === "Lecture"){
    if(currentSubject === "Science") showChapters(Object.keys(resourcesData["Science"]).filter(k=>k!=="NCERT"));
    else if(currentSubject === "Math") showChapters(Object.keys(resourcesData["Math"]).filter(k=>k!=="NCERT"));
    else if(currentSubject === "English"){
        showChapters(["Beehive", "Moments", "Grammar", "Writing Skills"]);
    }
    else if(currentSubject === "Social Science"){
        showChapters([
            { name: "History", chapters: ["The French Revolution","Socialism In Europe and the Russian revolution","Nazims and the rise of Hitler","Forest society and Colonialism","Pastoralists in the morden world"] },
            { name: "Geography", chapters: ["India size and location","Physical feature of India","Drainage","Climate","Natural vegetation and wildlife","Population"] },
            { name: "Civics", chapters: ["What is democracy ? Why is democracy ?","Constitutional Design","Electoral Politics","Work of institutions","Democratic Rights"] },
            { name: "Economics", chapters: ["The story of village Palampur","People as resource","Poverty as a challenge","Food security in India"] }
        ]);
    } else alert(`${r} for ${currentSubject} coming soon!`);
    return;
  }
}

// Renders the Chapter Panel
window.showChapters = function(list){
  document.getElementById('chapterTitle').textContent = `${resourceType}` + (currentSubject ? ` - ${currentSubject}` : "");
  const grid = document.getElementById('chapterGrid');
  grid.innerHTML = "";

  // --- Sample Paper Logic --- 
  if(resourceType === "Sample Paper" && Array.isArray(list)){
    if (list.includes("Mid Term") && list.length === 2) { 
      document.getElementById('chapterTitle').textContent = `Sample Paper - Choose Term`;
      list.forEach(item => {
        const d = document.createElement('div');
        d.className = 'chapter';
        d.textContent = item;
        d.onclick = () => {
          if (item === "Mid Term") showChapters(["Science", "Math", "English", "Social Science", "Hindi", "Sanskrit"]); 
          else alert("Final Term sample papers coming soon!");
        };
        grid.appendChild(d);
      });
      showPanel('chapterPanel');
      return;
    }
    if (list.includes("Science") && list.every(i => typeof i === 'string')) { 
        document.getElementById('chapterTitle').textContent = `Sample Paper - Mid Term`;
        list.forEach(sub=>{
          const d = document.createElement('div');
          d.className = LOCKED_SUBJECTS.has(sub) ? 'chapter disabled' : 'chapter';
          d.textContent = sub;
          d.onclick = ()=> {
            if (LOCKED_SUBJECTS.has(sub)) return alert("Coming Soon üîí");
            const url = midTermLinks[sub];
            if(url && url !== "#") openNotesViewer(url, `${sub} Mid Term Paper`); 
            else alert(`PDF for ${sub} not available.`);
          };
          grid.appendChild(d);
        });
        showPanel('chapterPanel');
        return;
    }
  }
  
  // --- Normal Rendering (Notes/Lecture/Nested) ---
  list.forEach(item=>{
    const div = document.createElement('div');
    
    // Nested Subject/Component
    if(typeof item === 'object' && item.name){
      div.className = item.locked ? 'chapter disabled' : 'chapter';
      div.textContent = item.name;
      if(!item.locked){
        div.onclick = ()=> {
          if(item.chapters && item.chapters.length) showChapters(item.chapters);
          else alert(`Chapters for ${item.name} coming soon!`);
        };
      }
    } 
    // All other items 
    else {
      div.className = 'chapter';
      div.textContent = item;
      div.onclick = ()=> {
        // --- NCERT PDF FLOW (Final Link Open) ---
        if (item.endsWith(" NCERT PDF")) {
            const baseName = item.split(' ')[0]; 
            let linkKey;

            if (currentSubject === "English") {
                linkKey = baseName === "Beehive" ? "EnglishBeehive" : "Moments";
            } else if (currentSubject === "Social Science") {
                linkKey = baseName; 
            }

            const link = ncertLinks[linkKey];
            if(link && link !== "#") openNotesViewer(link, item); 
            else alert(`NCERT PDF for ${baseName} not available.`);
            return;
        }

        // --- ENGLISH NESTED FLOW (FIXED) ---
        if(currentSubject === "English"){
            if(item === "Beehive") showChapters(["Prose","Poem"]);
            else if(item === "Moments") showChapters(englishMoments);
            else if(item === "Grammar") showChapters(englishGrammar);
            else if(item === "Writing Skills") showChapters(englishWriting);
            else if(item === "Prose") showChapters(englishProse);
            else if(item === "Poem") showChapters(englishPoem);
            // If the item is a specific chapter/topic (e.g., Tenses, The Fun They Had), go to details
            else showDetails(currentSubject, item);
        }
        // --- Default: show chapter details ---
        else {
          showDetails(currentSubject, item);
        }
      };
    }
    grid.appendChild(div);
  });

  showPanel('chapterPanel');
};

// Open the Notes Viewer Panel
function openNotesViewer(url, title = "Notes"){
    if (url === '#' || url === 'no-notes-link') {
        alert("This resource is not available yet.");
        return;
    }
    document.getElementById('notesViewerTitle').textContent = title;
    document.getElementById('notesViewerFrame').src = url;
    showPanel('notesViewerPanel');
}
window.openNotesViewer = openNotesViewer;

// Renders the Detail Panel (Notes/Lecture buttons)
function showDetails(subject, chapter){
  const detailPanel = $('detailPanel');
  const detailTitle = $('detailTitle');
  const detailContent = $('detailContent');

  let res = resourcesData[subject] && resourcesData[subject][chapter];

  if(!detailPanel || !detailContent || !detailTitle){
    alert(`Resources for "${chapter}" not available yet.`);
    return;
  }

  detailTitle.textContent = `${chapter}` + (subject ? ` ‚Äî ${subject}` : "");
  detailContent.innerHTML = "";

  if(!res || (res.notes === "no-notes-link" && res.lecture === "no-lecture-link")){
    const p = document.createElement('p');
    p.textContent = 'Resources not available for this chapter yet.';
    detailContent.appendChild(p);
    showPanel('detailPanel');
    return;
  }

  // NOTES BUTTON: Modified to use the internal viewer function
  if(resourceType === 'Notes' || (res.notes && res.notes !== "no-notes-link" && res.notes !== "#")){
    const btn = document.createElement('button');
    btn.textContent = 'üìÑ Open Notes / PDF';
    
    if(res.notes && res.notes !== "no-notes-link" && res.notes !== "#"){
        btn.onclick = () => openNotesViewer(res.notes, `Notes: ${chapter}`);
    } else {
        btn.onclick = () => alert("Notes link not available yet.");
    }
    detailContent.appendChild(btn);
  }

  // LECTURE BUTTON (Locked as requested)
  if(LOCKED_RESOURCES.includes('Lecture')){
    const p = document.createElement('p');
    p.style.color = 'yellow';
    p.textContent = 'üé• Lecture is currently locked üîí';
    detailContent.appendChild(p);
  } else if(res.lecture && res.lecture !== "no-lecture-link"){
    const b = document.createElement('a');
    b.href = res.lecture;
    b.target = '_blank';
    b.rel = 'noopener noreferrer';
    b.className = 'resource-link';
    b.style.display = 'block';
    b.textContent = 'üé• Watch Lecture';
    b.onclick = res.lecture === 'no-lecture-link' || res.lecture === '#' ? () => alert("Lecture link not available yet.") : null;
    detailContent.appendChild(b);
  } else if(resourceType === 'Lecture') {
    const p = document.createElement('p');
    p.textContent = 'Lecture link placeholder (no link available).';
    detailContent.appendChild(p);
  }

  showPanel('detailPanel');
}

/* ================= Auth Helpers (UPDATED) ================= */

window.signIn = async ()=> {
  try{
    const email = ($('loginEmail') || {}).value || '';
    const pass = ($('loginPass') || {}).value || '';

    // Set Persistence to LOCAL (keeps the user logged in indefinitely until explicitly signed out)
    await auth.setPersistence(browserLocalPersistence);
    
    await signInWithEmailAndPassword(auth, email, pass);
    
    window.history.replaceState({ panelId: 'homePanel' }, '', '#homePanel');
    showPanel('homePanel', true); 
  }catch(e){ alert(e.message || 'Login failed'); console.error(e); }
};
window.signUp = async ()=> {
  try{
    const email = ($('signupEmail') || {}).value || '';
    const pass = ($('signupPass') || {}).value || '';
    
    // Set Persistence to LOCAL for new sign-ups as well
    await auth.setPersistence(browserLocalPersistence);

    await createUserWithEmailAndPassword(auth, email, pass);
    alert("üéâ Account created!");
    
    window.history.replaceState({ panelId: 'homePanel' }, '', '#homePanel');
    showPanel('homePanel', true);
  }catch(e){ alert(e.message || 'Signup failed'); console.error(e); }
};
window.forgotPass = async ()=> {
  try{
    const email = ($('resetEmail') || {}).value || '';
    if(!email){ alert('Enter email in the reset box or use Forgot password flow'); return; }
    await sendPasswordResetEmail(auth, email);
    alert("Reset link sent!");
    showPanel('loginPanel');
  }catch(e){ alert(e.message || 'Reset failed'); console.error(e); }
};
window.logOut = async ()=> {
  try{ await signOut(auth); showPanel('loginPanel'); } catch(e){ console.error(e); showPanel('loginPanel'); }
};

</script>
</body>
</html>
